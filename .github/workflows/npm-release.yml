name: npm-release

on:
  workflow_call:
    inputs:
      node:
        type: string
        default: "24" # Node.js version to use
    secrets:
      NPM_TOKEN:
        required: true

# ------------------------------------------------------------
# âš™ï¸ Prevent concurrent runs on the same ref
# ------------------------------------------------------------
concurrency:
  group: npm-release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ------------------------------------------------------------
  # 1ï¸âƒ£ Create Git tag if package.json version changed
  # ------------------------------------------------------------
  tag:
    runs-on: ubuntu-24.04
    permissions:
      contents: write # Required to push new tags

    outputs:
      new_tag: ${{ steps.state.outputs.new_tag }}   # 'true' if a new tag was created
      version: ${{ steps.state.outputs.version }}   # current version from package.json

    steps:
      # ------------------------------------------------------------
      # 1. Checkout full repository (required to read history & tags)
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          fetch-depth: 0
          persist-credentials: false

      # ------------------------------------------------------------
      # 2. Setup Node.js environment
      #     - Required to read version with `node -p`
      # ------------------------------------------------------------
      - name: Setup Node
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: ${{ inputs.node }}

      # ------------------------------------------------------------
      # 3. Compute tag state (compare versions and create tag if needed)
      #     - Reads current and previous package.json versions
      #     - Creates and pushes a new tag if changed
      # ------------------------------------------------------------
      - name: Compute tag state
        id: state
        shell: bash
        env:
          NPM_CONFIG_IGNORE_SCRIPTS: "true"
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          # Read current version
          CUR="$(node -p 'require("./package.json").version')"
          echo "version=${CUR}" >> "$GITHUB_OUTPUT"

          # Read previous version (from previous commit)
          PREV="$(git show HEAD^:package.json 2>/dev/null | node -e 'let s="";process.stdin.on("data",d=>s+=d).on("end",()=>{try{console.log(JSON.parse(s).version)}catch{console.log("")}})')"
          echo "Current: ${CUR} | Previous: ${PREV}"

          # Skip if version unchanged
          if [ "${CUR}" = "${PREV}" ]; then
            echo "â„¹ï¸ No version change detected â€” skipping tag creation."
            echo "new_tag=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          TAG="v${CUR}"

          # Configure authenticated remote for fetch & push
          git remote add origin-auth "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          # Ensure tag does not already exist (remote tags)
          git fetch origin-auth --tags
          if git rev-parse "${TAG}" >/dev/null 2>&1; then
            echo "â„¹ï¸ Tag ${TAG} already exists â€” skipping."
            echo "new_tag=false" >> "$GITHUB_OUTPUT"
            git remote remove origin-auth || true
            exit 0
          fi

          # Create and push new tag
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${TAG}" -m "${TAG}"

          echo "ðŸš€ Pushing tag ${TAG}"
          git push origin-auth "refs/tags/${TAG}:refs/tags/${TAG}"
          git remote remove origin-auth || true

          echo "âœ… Created tag ${TAG}"
          echo "new_tag=true" >> "$GITHUB_OUTPUT"

  # ------------------------------------------------------------
  # 2ï¸âƒ£ Publish package to npm (only if a new tag was created)
  # ------------------------------------------------------------
  publish:
    needs: tag
    if: needs.tag.outputs.new_tag == 'true'
    runs-on: ubuntu-24.04
    permissions:
      contents: read         # read-only access to repo

    steps:
      # ------------------------------------------------------------
      # 1. Checkout repository
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      # ------------------------------------------------------------
      # 2. Setup Node.js environment
      # ------------------------------------------------------------
      - name: Setup Node
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: ${{ inputs.node }}
          registry-url: "https://registry.npmjs.org/"

      # ------------------------------------------------------------
      # 3. Configure npm authentication
      #     - Creates a temporary .npmrc with NPM_TOKEN
      # ------------------------------------------------------------
      - name: Configure npm authentication
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          {
            echo "registry=https://registry.npmjs.org/"
            echo "@synchronized:registry=https://registry.npmjs.org/"
            echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}"
            echo "always-auth=true"
          } > .npmrc
          echo "âœ… .npmrc configured successfully."

      # ------------------------------------------------------------
      # 4. Guard against duplicate publish
      #     - Skips if version already exists on npm
      # ------------------------------------------------------------
      - name: Guard against duplicate publish
        id: guard
        shell: bash
        env:
          NPM_CONFIG_IGNORE_SCRIPTS: "true"
        run: |
          set -euo pipefail
          NAME="$(node -p 'require("./package.json").name')"
          VER="$(node -p 'require("./package.json").version')"
          if npm view "${NAME}@${VER}" version >/dev/null 2>&1; then
            echo "â„¹ï¸ ${NAME}@${VER} already exists on npm â€” skipping publish."
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      # ------------------------------------------------------------
      # 5. Publish package to npm
      #     - Disabled lifecycle scripts for safety
      #     - Adds provenance (optional, via OIDC)
      # ------------------------------------------------------------
      - name: Publish package
        if: steps.guard.outputs.skip != 'true'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_IGNORE_SCRIPTS: "true"
        run: |
          set -euo pipefail
          echo "ðŸš€ Publishing package to npm..."
          npm publish
          echo "âœ… Publish completed successfully!"

      # ------------------------------------------------------------
      # 6. Cleanup sensitive files
      # ------------------------------------------------------------
      - name: Cleanup .npmrc
        if: always()
        run: |
          rm -f .npmrc || true
          echo "ðŸ§¹ Cleaned up temporary authentication file."
