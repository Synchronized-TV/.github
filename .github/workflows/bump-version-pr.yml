name: bump-version-pr

on:
  workflow_call:
    inputs:
      bump:
        type: string
        default: "patch" # patch | minor | major
      base:
        type: string
        default: "main"
      node:
        type: string
        default: "24"     # Node.js version to use

# ------------------------------------------------------------
# ‚öôÔ∏è Prevent concurrent runs on the same repo/base
# ------------------------------------------------------------
concurrency:
  group: bump-version-pr-${{ github.repository }}-${{ inputs.base }}
  cancel-in-progress: false

jobs:
  # ------------------------------------------------------------
  # 1Ô∏è‚É£ Bump package version and open a PR
  # ------------------------------------------------------------
  bump:
    runs-on: ubuntu-24.04

    # Elevate only what this job needs
    permissions:
      contents: write
      pull-requests: write
      issues: write   # needed if you want labels applied on the PR

    steps:
      # ------------------------------------------------------------
      # 1. Checkout full repo history (needed for version bump)
      #    - Do not persist credentials; push will use an explicit remote
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0
          persist-credentials: false

      # ------------------------------------------------------------
      # 2. Setup Node.js environment
      # ------------------------------------------------------------
      - name: Setup Node
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: ${{ inputs.node }}
          registry-url: "https://registry.npmjs.org/"

      # ------------------------------------------------------------
      # 3. Bump the version in package.json (no git tag)
      #    - Disable npm lifecycle scripts for safety
      # ------------------------------------------------------------
      - name: Bump version (no tag)
        id: bump
        shell: bash
        env:
          NPM_CONFIG_IGNORE_SCRIPTS: "true"
        run: |
          set -euo pipefail
          echo "üîß Bumping version: ${{ inputs.bump }}"
          npm version "${{ inputs.bump }}" --no-git-tag-version
          ver=$(node -p "require('./package.json').version")
          printf 'ver=%s\n' "$ver" >> "$GITHUB_OUTPUT"
          echo "üì¶ New version: v$ver"

      # ------------------------------------------------------------
      # 4. Commit and push the bump
      #    - Create a release branch and push via explicit HTTPS remote
      # ------------------------------------------------------------
      - name: Commit and push bump branch
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ver=${{ steps.bump.outputs.ver }}
          BR="release/bump-v${ver}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "üöÄ Creating branch $BR"
          git checkout -b "$BR"

          # Add versioned files (lockfile is optional)
          for file in package.json package-lock.json yarn.lock pnpm-lock.yaml; do
            [ -f "$file" ] && git add "$file"
          done

          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è No changes to commit ‚Äî exiting."
            exit 0
          fi

          git commit -m "chore(release): v${ver}"

          # Push via an ephemeral remote using GITHUB_TOKEN
          git remote add origin-auth "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git push -u origin-auth "$BR"
          git remote remove origin-auth || true

      # ------------------------------------------------------------
      # 5. Create or update the PR via GitHub Script
      #    - Labels are best-effort (won't fail the job)
      # ------------------------------------------------------------
      - name: Create PR
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { repo, owner } = context.repo;
            const version = process.env.VERSION;
            const branch = `release/bump-v${version}`;
            const base = process.env.BASE;
            const title = `chore(release): v${version}`;
            const body = `Automated version bump to v${version}`;

            try {
              const pr = await github.rest.pulls.create({ owner, repo, head: branch, base, title, body });
              core.info(`‚úÖ Created PR: ${pr.data.html_url}`);

              // Best-effort label (doesn't fail if missing permission/label)
              try {
                await github.rest.issues.addLabels({
                  owner, repo, issue_number: pr.data.number, labels: ["release"]
                });
              } catch {
                core.info("‚ÑπÔ∏è Skipping label (missing permission or label)");
              }
            } catch (error) {
              if (error.status === 422) {
                core.info("‚ÑπÔ∏è PR already exists or no changes detected ‚Äî skipping");
              } else {
                throw error;
              }
            }
        env:
          VERSION: ${{ steps.bump.outputs.ver }}
          BASE: ${{ inputs.base }}
