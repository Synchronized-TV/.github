name: bump-version-pr

on:
  workflow_call:
    inputs:
      bump:
        type: string
        default: "patch" # patch | minor | major
      base:
        type: string
        default: "main"
      node:
        type: string
        default: "20"
    secrets:
      NPM_TOKEN:
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  bump:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # 1Ô∏è‚É£ Checkout full repo history (needed for version bump)
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------
      # 2Ô∏è‚É£ Setup Node.js environment
      # ------------------------------------------------------------
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node }}
          registry-url: "https://registry.npmjs.org/"

      # ------------------------------------------------------------
      # 3Ô∏è‚É£ Bump the version number in package.json
      #     - Does not create git tags
      #     - Reads new version and sets output
      # ------------------------------------------------------------
      - name: Bump version (no tag)
        id: bump
        shell: bash
        run: |
          set -euo pipefail
          echo "üîß Bumping version: ${{ inputs.bump }}"

          npm version "${{ inputs.bump }}" --no-git-tag-version

          # Extract new version from package.json
          ver=$(node -p "require('./package.json').version")
          printf 'ver=%s\n' "$ver" >> "$GITHUB_OUTPUT"

          echo "üì¶ New version: v$ver"

      # ------------------------------------------------------------
      # 4Ô∏è‚É£ Commit and push version bump
      #     - Creates a dedicated release branch
      #     - Adds package.json and any lockfile present
      # ------------------------------------------------------------
      - name: Commit and push bump branch
        shell: bash
        run: |
          set -euo pipefail
          ver=${{ steps.bump.outputs.ver }}
          BR="release/bump-v${ver}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "üöÄ Creating branch $BR"
          git checkout -b "$BR"

          # Add versioned files (lockfile is optional)
          for file in package.json package-lock.json yarn.lock pnpm-lock.yaml; do
            [ -f "$file" ] && git add "$file"
          done

          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è No changes to commit. Exiting."
            exit 0
          fi

          git commit -m "chore(release): v${ver}"
          git push -u origin "$BR"
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      # ------------------------------------------------------------
      # 5Ô∏è‚É£ Create or update PR via GitHub Script
      #     - Replaces peter-evans/create-pull-request
      #     - Fully self-contained
      # ------------------------------------------------------------
      - name: Create PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { repo, owner } = context.repo;
            const version = process.env.VERSION;
            const branch = `release/bump-v${version}`;
            const base = process.env.BASE;
            const title = `chore(release): v${version}`;
            const body = `Automated version bump to v${version}`;

            try {
              const pr = await github.rest.pulls.create({
                owner,
                repo,
                head: branch,
                base,
                title,
                body
              });

              core.info(`‚úÖ Created PR: ${pr.data.html_url}`);

              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: pr.data.number,
                labels: ["release"]
              });
            } catch (error) {
              if (error.status === 422) {
                core.info("‚ÑπÔ∏è PR already exists or no changes detected ‚Äî skipping");
              } else {
                throw error;
              }
            }
        env:
          VERSION: ${{ steps.bump.outputs.ver }}
          BASE: ${{ inputs.base }}
